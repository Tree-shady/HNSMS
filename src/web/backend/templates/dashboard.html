{% extends 'base.html' %}

{% block content %}
<h1 class="mb-4">
    <i class="fa fa-dashboard"></i> 仪表盘
</h1>

<!-- 状态卡片 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary mb-3">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fa fa-server"></i> 系统状态
                </h5>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="fs-1" id="system-status">正常</div>
                    <div class="text-end">
                        <div class="small">模式</div>
                        <div id="system-mode">学习模式</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success mb-3">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fa fa-desktop"></i> 设备总数
                </h5>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="fs-1" id="total-devices">0</div>
                    <div class="text-end">
                        <div class="small">在线设备</div>
                        <div id="online-devices">0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning mb-3">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fa fa-bell"></i> 未处理告警
                </h5>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="fs-1" id="pending-alerts">0</div>
                    <div class="text-end">
                        <div class="small">今日告警</div>
                        <div id="today-alerts">0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info mb-3">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fa fa-exchange"></i> 流量统计
                </h5>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="fs-1" id="total-traffic">0 MB</div>
                    <div class="text-end">
                        <div class="small">活跃会话</div>
                        <div id="active-sessions">0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 详细信息 -->
<div class="row">
    <!-- 最近告警 -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fa fa-bell"></i> 最近告警
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>时间</th>
                                <th>类型</th>
                                <th>严重程度</th>
                                <th>描述</th>
                                <th>状态</th>
                            </tr>
                        </thead>
                        <tbody id="recent-alerts">
                            <!-- 告警数据将通过JavaScript动态加载 -->
                            <tr>
                                <td colspan="5" class="text-center">
                                    <i class="fa fa-spinner fa-spin"></i> 加载中...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="text-end mt-2">
                    <a href="{{ url_for('alerts_page') }}" class="btn btn-sm btn-primary">
                        查看所有告警
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 设备状态 -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fa fa-desktop"></i> 设备状态
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>设备名称</th>
                                <th>IP地址</th>
                                <th>设备类型</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="device-status">
                            <!-- 设备数据将通过JavaScript动态加载 -->
                            <tr>
                                <td colspan="5" class="text-center">
                                    <i class="fa fa-spinner fa-spin"></i> 加载中...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="text-end mt-2">
                    <a href="{{ url_for('devices_page') }}" class="btn btn-sm btn-primary">
                        查看所有设备
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 图表区域 -->
<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fa fa-pie-chart"></i> 设备类型分布
                </h5>
            </div>
            <div class="card-body">
                <canvas id="device-type-chart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fa fa-bar-chart"></i> 告警统计
                </h5>
            </div>
            <div class="card-body">
                <canvas id="alert-stats-chart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // 页面加载完成后执行
    $(document).ready(function() {
        // 加载系统状态
        loadSystemStatus();
        // 加载最近告警
        loadRecentAlerts();
        // 加载设备状态
        loadDeviceStatus();
        // 初始化图表
        initCharts();
        
        // 每30秒刷新一次数据
        setInterval(function() {
            loadSystemStatus();
            loadRecentAlerts();
            loadDeviceStatus();
        }, 30000);
    });
    
    // 加载系统状态
    function loadSystemStatus() {
        $.getJSON('/api/status', function(data) {
            if (data.success) {
                const status = data.data;
                
                // 更新系统状态
                $('#system-mode').text(status.system.mode === 'learning' ? '学习模式' : '检测模式');
                
                // 更新设备统计
                $('#total-devices').text(status.devices.total);
                $('#online-devices').text(status.devices.online);
                
                // 更新告警统计
                $('#pending-alerts').text(status.alerts.total_alerts);
                
                // 更新流量统计
                const totalBytes = status.traffic.total_bytes || 0;
                const totalMB = (totalBytes / (1024 * 1024)).toFixed(2);
                $('#total-traffic').text(totalMB + ' MB');
            }
        });
    }
    
    // 加载最近告警
    function loadRecentAlerts() {
        $.getJSON('/api/alerts', function(data) {
            if (data.success) {
                const alerts = data.data.alerts.slice(0, 5); // 只显示最近5条
                const tbody = $('#recent-alerts');
                
                tbody.empty();
                
                if (alerts.length === 0) {
                    tbody.append('<tr><td colspan="5" class="text-center">暂无告警</td></tr>');
                    return;
                }
                
                alerts.forEach(alert => {
                    const statusClass = {
                        'new': 'badge bg-danger',
                        'acknowledged': 'badge bg-warning',
                        'resolved': 'badge bg-success',
                        'closed': 'badge bg-secondary'
                    }[alert.status] || 'badge bg-secondary';
                    
                    const datetime = new Date(alert.timestamp * 1000).toLocaleString();
                    
                    tbody.append(`
                        <tr>
                            <td>${datetime}</td>
                            <td>${alert.alert_type}</td>
                            <td>${alert.severity}</td>
                            <td>${alert.description}</td>
                            <td><span class="${statusClass}">${alert.status}</span></td>
                        </tr>
                    `);
                });
            }
        });
    }
    
    // 加载设备状态
    function loadDeviceStatus() {
        $.getJSON('/api/devices', function(data) {
            if (data.success) {
                const devices = data.data.devices.slice(0, 5); // 只显示最近5条
                const tbody = $('#device-status');
                
                tbody.empty();
                
                if (devices.length === 0) {
                    tbody.append('<tr><td colspan="5" class="text-center">暂无设备</td></tr>');
                    return;
                }
                
                devices.forEach(device => {
                    const statusClass = {
                        'online': 'badge bg-success',
                        'offline': 'badge bg-danger',
                        'isolated': 'badge bg-warning'
                    }[device.status] || 'badge bg-secondary';
                    
                    const hostname = device.hostname || '未知设备';
                    
                    tbody.append(`
                        <tr>
                            <td>${hostname}</td>
                            <td>${device.ip_address}</td>
                            <td>${device.device_type}</td>
                            <td><span class="${statusClass}">${device.status}</span></td>
                            <td>
                                <button class="btn btn-sm btn-info">查看详情</button>
                            </td>
                        </tr>
                    `);
                });
            }
        });
    }
    
    // 初始化图表
    function initCharts() {
        // 设备类型分布图表
        const deviceTypeCtx = document.getElementById('device-type-chart').getContext('2d');
        new Chart(deviceTypeCtx, {
            type: 'pie',
            data: {
                labels: ['电脑', '移动设备', 'IoT设备', '其他'],
                datasets: [{
                    data: [1, 2, 3, 4],
                    backgroundColor: [
                        '#007bff',
                        '#28a745',
                        '#ffc107',
                        '#6c757d'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
        
        // 告警统计图表
        const alertStatsCtx = document.getElementById('alert-stats-chart').getContext('2d');
        new Chart(alertStatsCtx, {
            type: 'bar',
            data: {
                labels: ['低', '中', '高', '严重'],
                datasets: [{
                    label: '告警数量',
                    data: [0, 0, 0, 0],
                    backgroundColor: [
                        '#28a745',
                        '#ffc107',
                        '#fd7e14',
                        '#dc3545'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
</script>
{% endblock %}