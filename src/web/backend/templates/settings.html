{% extends 'base.html' %}

{% block content %}
<h1 class="mb-4">
    <i class="fa fa-cog"></i> 系统设置
</h1>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title">系统配置</h5>
            </div>
            <div class="card-body">
                <form>
                    <div class="mb-3">
                        <label for="system-mode" class="form-label">系统模式</label>
                        <select class="form-select" id="system-mode">
                            <option value="learning">学习模式</option>
                            <option value="detection">检测模式</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="scan-interval" class="form-label">设备扫描间隔 (秒)</label>
                        <input type="number" class="form-control" id="scan-interval" value="300">
                    </div>
                    <div class="mb-3">
                        <label for="log-level" class="form-label">日志级别</label>
                        <select class="form-select" id="log-level">
                            <option value="DEBUG">DEBUG</option>
                            <option value="INFO" selected>INFO</option>
                            <option value="WARNING">WARNING</option>
                            <option value="ERROR">ERROR</option>
                            <option value="CRITICAL">CRITICAL</option>
                        </select>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="unknown-device-alert">
                        <label class="form-check-label" for="unknown-device-alert">未知设备告警</label>
                    </div>
                    <div class="mb-3">
                        <label for="main-router-ip" class="form-label">主路由器IP地址</label>
                        <input type="text" class="form-control" id="main-router-ip" placeholder="例如: 192.168.0.1">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="include-local-machine">
                        <label class="form-check-label" for="include-local-machine">将本机加入设备管理</label>
                    </div>
                    <button type="submit" class="btn btn-primary">保存设置</button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title">网络配置</h5>
            </div>
            <div class="card-body">
                <form>
                    <div class="mb-3">
                        <label for="network-interface" class="form-label">监控网络接口</label>
                        <select class="form-select" id="network-interface">
                            <option value="all">所有接口</option>
                            <option value="eth0">以太网</option>
                            <option value="wlan0">无线网络</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="ip-range" class="form-label">监控IP范围</label>
                        <input type="text" class="form-control" id="ip-range" value="192.168.0.0/24">
                    </div>
                    <div class="mb-3">
                        <label for="alert-threshold" class="form-label">告警阈值 (数据包/秒)</label>
                        <input type="number" class="form-control" id="alert-threshold" value="1000">
                    </div>
                    <button type="submit" class="btn btn-primary">保存设置</button>
                </form>
            </div>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-md-12">
            <h3>高级配置</h3>
        </div>
    </div>
    
    <!-- 网络配置 -->
    <div class="row mt-2">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title">网络代理配置</h5>
                </div>
                <div class="card-body">
                    <form id="proxy-config-form">
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="proxy-enabled">
                            <label class="form-check-label" for="proxy-enabled">启用代理</label>
                        </div>
                        <div class="mb-3">
                            <label for="proxy-type" class="form-label">代理类型</label>
                            <select class="form-select" id="proxy-type">
                                <option value="http">HTTP</option>
                                <option value="https">HTTPS</option>
                                <option value="socks5">SOCKS5</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="proxy-host" class="form-label">代理主机</label>
                            <input type="text" class="form-control" id="proxy-host" placeholder="例如: 127.0.0.1">
                        </div>
                        <div class="mb-3">
                            <label for="proxy-port" class="form-label">代理端口</label>
                            <input type="number" class="form-control" id="proxy-port" value="8080">
                        </div>
                        <div class="mb-3">
                            <label for="proxy-username" class="form-label">用户名</label>
                            <input type="text" class="form-control" id="proxy-username" placeholder="可选">
                        </div>
                        <div class="mb-3">
                            <label for="proxy-password" class="form-label">密码</label>
                            <input type="password" class="form-control" id="proxy-password" placeholder="可选">
                        </div>
                        <button type="submit" class="btn btn-primary">保存代理设置</button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title">DNS配置</h5>
                </div>
                <div class="card-body">
                    <form id="dns-config-form">
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="dns-enabled">
                            <label class="form-check-label" for="dns-enabled">启用自定义DNS</label>
                        </div>
                        <div class="mb-3">
                            <label for="dns-servers" class="form-label">DNS服务器 (逗号分隔)</label>
                            <input type="text" class="form-control" id="dns-servers" placeholder="例如: 8.8.8.8, 8.8.4.4">
                        </div>
                        <div class="mb-3">
                            <label for="dns-timeout" class="form-label">DNS超时 (秒)</label>
                            <input type="number" class="form-control" id="dns-timeout" value="5">
                        </div>
                        <button type="submit" class="btn btn-primary">保存DNS设置</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 性能配置 -->
    <div class="row mt-2">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title">性能配置</h5>
                </div>
                <div class="card-body">
                    <form id="performance-config-form">
                        <div class="mb-3">
                            <label for="max-memory" class="form-label">最大内存使用 (MB)</label>
                            <input type="number" class="form-control" id="max-memory" value="2048">
                        </div>
                        <div class="mb-3">
                            <label for="traffic-analyzer-threads" class="form-label">流量分析线程数</label>
                            <input type="number" class="form-control" id="traffic-analyzer-threads" value="4">
                        </div>
                        <div class="mb-3">
                            <label for="signature-detection-threads" class="form-label">签名检测线程数</label>
                            <input type="number" class="form-control" id="signature-detection-threads" value="2">
                        </div>
                        <div class="mb-3">
                            <label for="anomaly-detection-threads" class="form-label">异常检测线程数</label>
                            <input type="number" class="form-control" id="anomaly-detection-threads" value="2">
                        </div>
                        <button type="submit" class="btn btn-primary">保存性能设置</button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- UI配置 -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title">UI配置</h5>
                </div>
                <div class="card-body">
                    <form id="ui-config-form">
                        <div class="mb-3">
                            <label for="ui-theme" class="form-label">主题</label>
                            <select class="form-select" id="ui-theme">
                                <option value="light">浅色</option>
                                <option value="dark">深色</option>
                                <option value="auto">自动</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="ui-language" class="form-label">语言</label>
                            <select class="form-select" id="ui-language">
                                <option value="zh_CN">中文</option>
                                <option value="en_US">English</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="ui-refresh-interval" class="form-label">自动刷新间隔 (秒)</label>
                            <input type="number" class="form-control" id="ui-refresh-interval" value="30">
                        </div>
                        <button type="submit" class="btn btn-primary">保存UI设置</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 备份配置 -->
    <div class="row mt-2">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title">备份配置</h5>
                </div>
                <div class="card-body">
                    <form id="backup-config-form">
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="backup-enabled">
                            <label class="form-check-label" for="backup-enabled">启用自动备份</label>
                        </div>
                        <div class="mb-3">
                            <label for="backup-frequency" class="form-label">备份频率</label>
                            <select class="form-select" id="backup-frequency">
                                <option value="daily">每日</option>
                                <option value="weekly">每周</option>
                                <option value="monthly">每月</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="backup-time" class="form-label">备份时间</label>
                            <input type="time" class="form-control" id="backup-time" value="02:00">
                        </div>
                        <div class="mb-3">
                            <label for="backup-retention-days" class="form-label">备份保留天数</label>
                            <input type="number" class="form-control" id="backup-retention-days" value="30">
                        </div>
                        <button type="submit" class="btn btn-primary">保存备份设置</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 页面加载完成后执行
    $(document).ready(function() {
        // 从API获取当前配置
        function loadConfig() {
            $.ajax({
                url: '/api/config',
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        const config = response.data;
                        
                        // 填充系统配置表单
                        $('#system-mode').val(config.system.mode);
                        $('#scan-interval').val(config.device_manager.scan_interval_seconds);
                        $('#log-level').val(config.system.log_level);
                        $('#unknown-device-alert').prop('checked', config.device_manager.unknown_device_alert);
                        $('#main-router-ip').val(config.device_manager.main_router_ip);
                        $('#include-local-machine').prop('checked', config.device_manager.include_local_machine);
                        
                        // 填充代理配置表单
                        if (config.network && config.network.proxy) {
                            $('#proxy-enabled').prop('checked', config.network.proxy.enabled);
                            $('#proxy-type').val(config.network.proxy.type);
                            $('#proxy-host').val(config.network.proxy.host);
                            $('#proxy-port').val(config.network.proxy.port);
                            $('#proxy-username').val(config.network.proxy.username);
                            $('#proxy-password').val(config.network.proxy.password);
                        }
                        
                        // 填充DNS配置表单
                        if (config.network && config.network.dns) {
                            $('#dns-enabled').prop('checked', config.network.dns.enabled);
                            $('#dns-servers').val(config.network.dns.servers.join(', '));
                            $('#dns-timeout').val(config.network.dns.timeout_seconds);
                        }
                        
                        // 填充性能配置表单
                        if (config.performance) {
                            $('#max-memory').val(config.performance.memory.max_usage_mb);
                            $('#traffic-analyzer-threads').val(config.performance.threads.traffic_analyzer);
                            $('#signature-detection-threads').val(config.performance.threads.signature_detection);
                            $('#anomaly-detection-threads').val(config.performance.threads.anomaly_detection);
                        }
                        
                        // 填充UI配置表单
                        if (config.ui) {
                            $('#ui-theme').val(config.ui.theme);
                            $('#ui-language').val(config.ui.language);
                            $('#ui-refresh-interval').val(config.ui.refresh_interval);
                        }
                        
                        // 填充备份配置表单
                        if (config.backup) {
                            $('#backup-enabled').prop('checked', config.backup.enabled);
                            $('#backup-frequency').val(config.backup.schedule.frequency);
                            $('#backup-time').val(config.backup.schedule.time);
                            $('#backup-retention-days').val(config.backup.retention.days);
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load config:', error);
                }
            });
        }
        
        // 保存配置到API
        function saveConfig(configData) {
            $.ajax({
                url: '/api/config',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(configData),
                success: function(response) {
                    if (response.success) {
                        alert('设置已保存');
                    } else {
                        alert('保存失败: ' + response.error);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Failed to save config:', error);
                    alert('保存失败: ' + error);
                }
            });
        }
        
        // 加载配置
        loadConfig();
        
        // 绑定系统配置表单提交事件
        $('form').first().submit(function(e) {
            e.preventDefault();
            
            // 收集表单数据
            const configData = {
                'system.mode': $('#system-mode').val(),
                'device_manager.scan_interval_seconds': parseInt($('#scan-interval').val()),
                'system.log_level': $('#log-level').val(),
                'device_manager.unknown_device_alert': $('#unknown-device-alert').prop('checked'),
                'device_manager.main_router_ip': $('#main-router-ip').val(),
                'device_manager.include_local_machine': $('#include-local-machine').prop('checked')
            };
            
            // 保存配置
            saveConfig(configData);
        });
        
        // 绑定代理配置表单提交事件
        $('#proxy-config-form').submit(function(e) {
            e.preventDefault();
            
            // 收集表单数据
            const configData = {
                'network.proxy.enabled': $('#proxy-enabled').prop('checked'),
                'network.proxy.type': $('#proxy-type').val(),
                'network.proxy.host': $('#proxy-host').val(),
                'network.proxy.port': parseInt($('#proxy-port').val()),
                'network.proxy.username': $('#proxy-username').val(),
                'network.proxy.password': $('#proxy-password').val()
            };
            
            // 保存配置
            saveConfig(configData);
        });
        
        // 绑定DNS配置表单提交事件
        $('#dns-config-form').submit(function(e) {
            e.preventDefault();
            
            // 收集表单数据
            const configData = {
                'network.dns.enabled': $('#dns-enabled').prop('checked'),
                'network.dns.servers': $('#dns-servers').val().split(',').map(server => server.trim()),
                'network.dns.timeout_seconds': parseInt($('#dns-timeout').val())
            };
            
            // 保存配置
            saveConfig(configData);
        });
        
        // 绑定性能配置表单提交事件
        $('#performance-config-form').submit(function(e) {
            e.preventDefault();
            
            // 收集表单数据
            const configData = {
                'performance.memory.max_usage_mb': parseInt($('#max-memory').val()),
                'performance.threads.traffic_analyzer': parseInt($('#traffic-analyzer-threads').val()),
                'performance.threads.signature_detection': parseInt($('#signature-detection-threads').val()),
                'performance.threads.anomaly_detection': parseInt($('#anomaly-detection-threads').val())
            };
            
            // 保存配置
            saveConfig(configData);
        });
        
        // 绑定UI配置表单提交事件
        $('#ui-config-form').submit(function(e) {
            e.preventDefault();
            
            // 收集表单数据
            const configData = {
                'ui.theme': $('#ui-theme').val(),
                'ui.language': $('#ui-language').val(),
                'ui.refresh_interval': parseInt($('#ui-refresh-interval').val())
            };
            
            // 保存配置
            saveConfig(configData);
        });
        
        // 绑定备份配置表单提交事件
        $('#backup-config-form').submit(function(e) {
            e.preventDefault();
            
            // 收集表单数据
            const configData = {
                'backup.enabled': $('#backup-enabled').prop('checked'),
                'backup.schedule.frequency': $('#backup-frequency').val(),
                'backup.schedule.time': $('#backup-time').val(),
                'backup.retention.days': parseInt($('#backup-retention-days').val())
            };
            
            // 保存配置
            saveConfig(configData);
        });
    });
</script>
{% endblock %}