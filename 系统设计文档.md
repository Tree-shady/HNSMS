# 家庭网络安全监控系统设计文档

## 1. 系统概述

### 1.1 设计理念
从“被动防御”转向“主动态势感知”，将家庭网络视为一个需要持续监控和管理的整体，而非仅仅是保护单个设备。

### 1.2 系统目标
- 全面监控家庭网络流量
- 实时检测和响应网络威胁
- 提供可视化的网络拓扑和安全状态
- 支持设备管理和分组策略
- 保护智能设备（IoT）安全
- 提供家长控制和内容过滤功能
- 保护用户隐私

## 2. 技术栈选择

### 2.1 核心中枢硬件
- **处理器**：ARM Cortex-A72 四核处理器（如树莓派4B或类似硬件）
- **内存**：4GB RAM
- **存储**：32GB eMMC + 可扩展SD卡
- **网络接口**：2个千兆以太网端口（WAN/LAN）
- **无线接口**：802.11ac双频WiFi
- **操作系统**：基于Linux的定制固件（如OpenWrt或Raspbian）

### 2.2 软件架构

| 模块 | 技术选型 | 说明 |
|------|----------|------|
| 流量镜像与分析 | Netfilter/iptables | 用于流量捕获和转发 |
| 安全分析引擎 | Python 3.8+ | 核心分析逻辑 |
| 签名检测 | Suricata | 开源入侵检测系统 |
| 异常行为分析 | Scikit-learn/TensorFlow Lite | 机器学习模型 |
| 威胁情报集成 | MISP/OTX | 威胁情报平台集成 |
| 统一管理平台 | React + Node.js | Web前端和API服务 |
| 移动App | Flutter | 跨平台移动应用 |
| 设备管理 | ARP扫描 + nmap | 设备发现和识别 |
| 数据库 | SQLite + Redis | 本地数据存储和缓存 |

## 3. 系统架构与模块设计

### 3.1 系统整体架构

```
+---------------------+     +---------------------+     +---------------------+
|                     |     |                     |     |                     |
|   家庭网络设备      |     |   核心中枢硬件      |     |   云端服务          |
|                     |     |                     |     |                     |
+---------------------+     +---------------------+     +---------------------+
         |                            |                            |
         | 流量镜像/管理策略           | 威胁情报更新/沙箱分析        |
         |<-------------------------->|--------------------------->|
         |                            |                            |
         | 设备发现/行为数据          | 安全分析/警报生成           |
         |--------------------------->|--------------------------->|
         |                            |                            |
         | 隔离/限速/封锁             | 策略执行                   |
         |<-------------------------->|                            |
         |                            |                            |
         |                            | 管理界面/告警推送           |
         |                            |<--------------------------->|
         |                            |                            |
         |                            |          统一管理平台       |
         |                            |                            |
         |                            |  +---------------------+   |
         |                            |  |  Web管理界面       |   |
         |                            |  +---------------------+   |
         |                            |  |  移动App            |   |
         |                            |  +---------------------+   |
         |                            |                            |
```

### 3.2 核心模块详细设计

#### 3.2.1 核心中枢硬件

**功能设计：**
- **流量镜像**：使用Netfilter/iptables将所有LAN侧流量复制到分析引擎
- **策略执行**：根据分析引擎的指令执行以下操作：
  - 阻断特定IP/端口通信
  - 隔离设备到特定VLAN
  - 限制设备带宽
- **统一管理接口**：提供RESTful API接口供Web和移动App访问

**硬件设计：**
- 双网卡设计：WAN口连接外部网络，LAN口连接家庭内部网络
- 支持WiFi接入，可作为家庭主路由器
- 硬件加速：支持硬件级别的数据包过滤和加密

#### 3.2.2 安全分析引擎

**签名检测：**
- 集成Suricata IDS引擎
- 规则库包括：
  - 已知恶意软件特征
  - 漏洞利用签名
  - 僵尸网络C&C服务器列表
  - 常见攻击模式（如SQL注入、XSS等）
- 规则库自动更新（每日一次）

**异常行为分析：**
- **基线学习**：
  - 初始1-2周学习模式
  - 收集每个设备的网络行为数据：
    - 访问的域名/IP
    - 通信时段
    - 数据流量大小
    - 连接频率
  - 建立设备行为基线模型

- **异常检测**：
  - 使用机器学习算法（如Isolation Forest、One-Class SVM）检测异常行为
  - 检测维度：
    - 异常时间通信
    - 异常流量大小
    - 异常连接目的地
    - 异常连接频率
  - 告警阈值可配置

**威胁情报集成：**
- 实时接入MISP和OTX等威胁情报平台
- 获取最新的恶意IP、域名、URL列表
- 支持本地缓存和离线使用

**AI驱动的沙箱：**
- 对可疑流量提取元数据（如文件哈希、网络行为）
- 发送至云端沙箱进行深度分析
- 支持未知威胁检测

#### 3.2.3 统一管理平台

**Web管理界面：**
- **仪表盘**：
  - 实时网络拓扑图（使用D3.js可视化）
  - 系统安全评分（0-100分）
  - 最近威胁事件列表
  - 在线设备统计

- **设备管理**：
  - 设备列表和详细信息
  - 设备分组管理
  - 设备行为基线查看
  - 设备隔离/解封操作

- **安全策略**：
  - 基于设备/分组的访问控制
  - 端口封锁规则
  - 流量限制设置
  - 家长控制配置

- **日志与报告**：
  - 完整的安全事件日志
  - 威胁检测报告
  - 设备行为分析报告
  - 支持日志导出

**移动App：**
- 推送实时安全告警
- 设备状态快速查看
- 一键设备隔离/解封
- 远程管理安全策略
- 安全事件历史查看

#### 3.2.4 设备身份与资产管理

**自动设备发现：**
- 使用ARP扫描发现新设备
- 结合nmap进行设备指纹识别
- 识别设备类型、厂商、型号
- 自动分配友好名称（可手动修改）

**设备画像：**
- 为每个设备建立安全档案：
  - 基本信息：MAC地址、IP地址、设备类型、厂商、型号
  - 网络行为基线
  - 已知漏洞信息
  - 所属用户/分组
  - 最近活动记录

**分组管理：**
- 支持自定义设备分组（如“儿童设备”、“工作设备”、“IoT设备”）
- 可针对分组应用统一安全策略
- 支持分组级别的行为分析和告警

## 4. 关键安全功能实现

### 4.1 智能设备（IoT）专项防护

**微隔离：**
- 为IoT设备创建独立VLAN
- 配置严格的访问控制列表（ACL）
- 限制IoT设备只能与必要的服务器通信
- 阻止IoT设备之间的横向通信

**默认拒绝策略：**
- 采用“出站允许，入站拒绝”的默认策略
- 只允许必要的入站连接
- 防止从外网直接入侵IoT设备

**漏洞预警：**
- 定期检查设备固件版本
- 与CVE数据库对比，识别已知漏洞
- 提供固件升级建议
- 支持临时隔离存在高危漏洞的设备

### 4.2 家长控制与内容过滤

**精细化上网时间管理：**
- 基于设备/分组的上网时间段设置
- 支持工作日/周末差异化配置
- 支持临时解禁功能

**分级内容过滤：**
- 基于域名分类的内容过滤
- 支持自定义过滤规则
- 过滤类别包括：成人内容、暴力、赌博、恶意软件等

**安全搜索强制：**
- 强制开启主流搜索引擎的安全搜索模式
- 支持自定义搜索引擎配置

### 4.3 隐私保护

**DNS加密：**
- 默认启用DNS-over-HTTPS (DoH)
- 支持配置自定义DoH服务器
- 防止ISP或本地网络窃听DNS查询

**数据出境监控：**
- 监控设备向境外IP的通信
- 对大量数据传输进行告警
- 支持查看数据传输详情

### 4.4 入侵检测与响应

**网络入侵检测系统（NIDS）：**
- 基于Suricata实现
- 检测常见网络攻击：
  - 端口扫描
  - 暴力破解
  - DDoS攻击
  - 恶意流量

**自动化响应：**
- **联动封锁**：
  - 检测到暴力破解时，自动将来源IP加入黑名单
  - 支持封锁时长配置
  - 支持手动解除封锁

- **设备隔离**：
  - 确认设备感染后，自动隔离至“沙箱网络”
  - 隔离期间仅允许访问安全更新服务器
  - 支持手动解除隔离

## 5. 系统部署与运维

### 5.1 部署方案

**硬件部署：**
- 核心中枢硬件作为家庭主路由器使用
- 连接到光猫或现有路由器的LAN口
- 配置为DHCP服务器，为家庭设备分配IP地址

**软件部署：**
- 基于OpenWrt定制固件，预安装所有必要组件
- 支持U盘/SD卡扩展存储
- 支持远程固件更新

### 5.2 系统初始化

1. **硬件连接**：将核心中枢连接到光猫和电源
2. **初始配置**：
   - 连接到初始WiFi热点
   - 通过Web界面进行基本配置（如WiFi名称、密码）
3. **学习模式**：
   - 系统进入1-2周的学习模式
   - 收集家庭设备的正常网络行为
   - 建立行为基线模型
4. **正式运行**：
   - 学习模式结束后，自动切换到正式运行模式
   - 开始实时威胁检测和告警

### 5.3 系统维护

- **自动更新**：
  - 威胁情报规则每日自动更新
  - 系统固件定期更新（可配置）
  - 机器学习模型定期优化

- **日志管理**：
  - 本地日志存储（支持配置存储时长）
  - 支持日志导出到外部存储
  - 重要事件自动备份到云端

- **故障恢复**：
  - 支持系统快照和恢复
  - 提供重置功能
  - 支持远程诊断

## 6. 系统安全性考虑

### 6.1 自身安全

- **固件安全**：
  - 固件签名验证
  - 防止未授权固件刷入
  - 支持安全启动

- **通信安全**：
  - 所有管理界面使用HTTPS
  - API通信使用JWT认证
  - 支持双因素认证

- **访问控制**：
  - 强密码策略
  - 支持访问IP限制
  - 定期密码更换提醒

### 6.2 数据安全

- **本地数据加密**：
  - 敏感数据加密存储
  - 加密密钥本地管理

- **云端数据保护**：
  - 仅上传必要的匿名数据
  - 数据传输加密
  - 支持数据删除请求

### 6.3 隐私保护

- **数据最小化**：
  - 仅收集必要的网络行为数据
  - 支持数据匿名化

- **用户控制**：
  - 支持查看和导出收集的数据
  - 支持数据删除
  - 支持关闭特定数据收集功能

## 7. 系统扩展与升级

### 7.1 功能扩展

- 支持插件机制，可扩展新功能
- 支持第三方集成（如智能家居平台）
- 支持自定义规则和策略

### 7.2 性能升级

- 支持硬件加速卡扩展
- 支持分布式部署（适用于大型家庭网络）
- 支持负载均衡

## 8. 测试与验证

### 8.1 功能测试

- 设备发现和识别准确性测试
- 流量镜像和分析功能测试
- 威胁检测准确性测试
- 告警和响应功能测试
- 管理界面功能测试

### 8.2 性能测试

- 最大支持设备数量测试
- 流量处理能力测试
- 告警延迟测试
- 系统资源占用测试

### 8.3 安全性测试

- 渗透测试
- 漏洞扫描
- 加密强度测试
- 抗DDoS测试

## 9. 结论

本设计文档详细描述了家庭网络安全监控系统的架构和功能，采用了多种先进技术实现主动态势感知和威胁防护。系统具有良好的扩展性和可维护性，能够有效保护家庭网络安全，为用户提供安全、可靠的网络环境。